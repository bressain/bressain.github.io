<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">Bressain | Swapping redux-thunk With redux-saga For Better Testing</title><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font-size:112.5%;line-height:1.65em;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:Roboto,sans-serif;font-weight:normal;word-wrap:break-word;}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Fjalla One,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:2rem;line-height:2.475rem;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Fjalla One,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.51572rem;line-height:2.475rem;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Fjalla One,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1.31951rem;line-height:1.65rem;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Fjalla One,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.65rem;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Fjalla One,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.87055rem;line-height:1.65rem;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;color:hsla(0,0%,0%,0.8);font-family:Fjalla One,sans-serif;font-weight:bold;text-rendering:optimizeLegibility;font-size:0.81225rem;line-height:1.65rem;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}ul{margin-left:1.65rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.65rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;font-size:0.85rem;line-height:1.42;background:hsla(0,0%,0%,0.04);border-radius:3px;overflow:auto;padding:1.65rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;font-size:1rem;line-height:1.65rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}blockquote{margin-left:1.65rem;margin-right:1.65rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.65rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.65rem;}b{font-weight:bold;}strong{font-weight:bold;}dt{font-weight:bold;}th{font-weight:bold;}li{margin-bottom:calc(1.65rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.65rem;margin-bottom:calc(1.65rem / 2);margin-top:calc(1.65rem / 2);}li > ul{margin-left:1.65rem;margin-bottom:calc(1.65rem / 2);margin-top:calc(1.65rem / 2);}code{font-size:0.85rem;line-height:1.65rem;}kbd{font-size:0.85rem;line-height:1.65rem;}samp{font-size:0.85rem;line-height:1.65rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:tnum;padding-left:1.1rem;padding-right:1.1rem;padding-top:0.825rem;padding-bottom:calc(0.825rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}tt,code{background-color:hsla(0,0%,0%,0.04);border-radius:3px;font-family:Consolas,"Roboto Mono","Liberation Mono",Menlo,Courier,monospace;padding:0;padding-top:0.2em;padding-bottom:0.2em;}pre code{background:none;line-height:1.42;}code:before,code:after,tt:before,tt:after{letter-spacing:-0.2em;content:" ";}pre code:before,pre code:after,pre tt:before,pre tt:after{content:"";}</style><link href="//fonts.googleapis.com/css?family=Fjalla+One:400|Roboto:400,400i,700,700i" rel="stylesheet" type="text/css"/><style>div,p{color:rgba(0,0,0,.8)}blockquote{border-left:4px solid rgba(0,0,0,.4);margin-left:0;padding-left:26.4px;padding-left:1.65rem}blockquote,blockquote>p{color:rgba(0,0,0,.4)}a{text-decoration:none;color:#39a939}a:hover{color:#5cc45c;text-decoration:underline}a:active{color:#8cdc8c}a:visited{color:#0a730a}img{margin:0}.inline-image{float:left;margin-right:15px}.center-image{text-align:center}.captioned-image p:last-of-type{font-size:.9em}.photo-credit{font-size:12px;margin-top:15px}.warning{color:#9f6000;background-color:#feefb3;padding:18px}.warning:before{content:"\26A0";margin-right:9px}.rfc-page pre{font-family:inherit}code{background-color:rgba(0,0,0,.08)}.hljs,.markdown pre{display:block;overflow-x:auto;padding:.5em;background:#282c34;color:#abb2bf;font-size:1.1em}.hljs>::-moz-selection{background-color:#3e4451}.hljs>::selection{background-color:#3e4451}.hljs-comment{color:#5c6370;font-style:italic}.hljs-selector-tag{color:#e06c75}.hljs-string{color:#98c379}.hljs-number,.hljs-regexp,.hljs-template-variable,.hljs-variable{color:#d19a66}.hljs-subst{color:#519f50}.hljs-keyword{color:#c678dd}.hljs-function>.hljs-title{color:#61afef}.hljs-tag{color:#abb2bf}.hljs-name{color:#e06c75}.hljs-type{color:#da4939}.hljs-attr{color:#d19a66}.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-link,.hljs-symbol{color:#6d9cbe}.hljs-params{color:#d0d0ff}.hljs-section,.hljs-title{color:#ffc66d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{color:#e6e1dc;display:inline-block;width:100%}.hljs-deletion{background-color:#600}.hljs-selector-class{color:#9b703f}.hljs-selector-id{color:#8b98ab}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}._3TkJV_CnHmTFJnSPlpaVyl{max-width:740px;margin-left:auto;margin-right:auto;padding:26.4px 19.8px;padding:1.65rem 1.2375rem}.fDHz6tW4nWFV-swnfS-QB{font-size:.75em;color:rgba(0,0,0,.6)}._33G3p6bz1BpdLtEoXn5NMH{padding-top:0}.RNIQbXZ4nOPl5GFKIQ60x{margin-bottom:26.4px;margin-bottom:1.65rem}._2dDgP7FETBMjXMzeaq_tqh{margin-bottom:6.6px;margin-bottom:.4125rem}._2cGs1ncVeWLYmD3Q1mIY2{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}._HJqmdx3qZVV_BpOPktPG{margin-left:.45em;margin-right:auto;max-width:370px}._HJqmdx3qZVV_BpOPktPG:before{border-style:solid;border-width:.2em .2em 0 0;content:"";display:inline-block;height:.45em;position:relative;top:.55em;vertical-align:top;width:.45em;left:-.45em;-webkit-transform:rotate(-135deg);transform:rotate(-135deg)}._33zoxpDtcDx_TbvUrQgVly{margin-right:.45em;margin-left:auto;max-width:370px}._33zoxpDtcDx_TbvUrQgVly:after{border-style:solid;border-width:.2em .2em 0 0;content:"";display:inline-block;height:.45em;position:relative;top:.55em;vertical-align:top;width:.45em;left:.45em;-webkit-transform:rotate(45deg);transform:rotate(45deg)}._1yjGQbDuYsN6wsY_5bKZfL{background-color:#0a730a}._2tL3kkyqo20uOMENVoLDq-{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-ms-flex-pack:justify;justify-content:space-between}@media only screen and (min-width:351px){._2tL3kkyqo20uOMENVoLDq-{max-width:350px;margin-left:auto;margin-right:auto}}._1z3s2NjYfLLOlZUetX0rsg{border-radius:50%;margin-bottom:0}._3feOmGaJaw4_cyrDHPZqar{fill:#fff;cursor:pointer;height:52.8px;height:3.3rem}._1bU9r8HJo0DQj5GQcGupks{display:-webkit-box;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-ms-flex-pack:center;justify-content:center;margin-top:26.4px;margin-top:1.65rem;font-size:.7em;max-width:350px;margin-left:auto;margin-right:auto}._1leBCDTt2Qdk5Vslgg0fDV{-ms-flex-item-align:center;-ms-grid-row-align:center;align-self:center}._1leBCDTt2Qdk5Vslgg0fDV img{margin-bottom:0}.Jwr2t2FwsSCNx58JK3rqN,.Jwr2t2FwsSCNx58JK3rqN a{color:#fff}.tLPlNhsvgeiCDdhNn_Vci{line-height:15.085px;line-height:.94286rem;margin-left:8px;color:#fff}.tLPlNhsvgeiCDdhNn_Vci a{color:#fff}._2P30oGZWShzybKYh3_L4el{background-color:#39a939;margin-bottom:26.4px;margin-bottom:1.65rem}._3lDxu0oZEr8vDWkBl5LAkb a{color:#fff;text-decoration:none}._2RTdlDUVxIohqDvdbObAqR{padding-top:0}._3zmRFjv38K5w2HddzG5ZRz{background-image:linear-gradient(#39a939,#1f911f)}.NxULpU0HW0xy_Dw0nDfo{padding-top:105.6px;padding-top:6.6rem;padding-bottom:105.6px;padding-bottom:6.6rem;text-align:center}._1cnjyOVgA5aFKzLRc73I1m{font-family:Roboto,sans-serif;font-weight:400;font-size:2em;margin-bottom:0}._1cnjyOVgA5aFKzLRc73I1m a{color:#fff;text-decoration:none}._110RSi2eVDJfc19epVYSnt{margin-left:0}.O4MPK2YFaXrB3nqKnxADp{list-style:none}._3fxkBT7-smkds1TIu0bggu{display:inline-block}.U9olFQBRb5Kjs3TLuPKYo{clear:both;position:relative;top:-26.4px;top:-1.65rem;text-align:right}</style></head><body><div id="react-mount"><div data-reactroot="" data-reactid="1" data-react-checksum="102514917"><!-- react-empty: 2 --><div class="markdown" data-reactid="3"><!-- react-empty: 4 --><div data-reactid="5"><header class="_2P30oGZWShzybKYh3_L4el" data-reactid="6"><hgroup class="_3lDxu0oZEr8vDWkBl5LAkb _3TkJV_CnHmTFJnSPlpaVyl" data-reactid="7"><a href="/" data-reactid="8">Bressain.com</a></hgroup></header><section class="_33G3p6bz1BpdLtEoXn5NMH _3TkJV_CnHmTFJnSPlpaVyl" data-reactid="9"><header class="RNIQbXZ4nOPl5GFKIQ60x" data-reactid="10"><h1 class="_2dDgP7FETBMjXMzeaq_tqh" data-reactid="11">Swapping redux-thunk With redux-saga For Better Testing</h1><div class="kN3Tbs1DlFHkrp64USbSc fDHz6tW4nWFV-swnfS-QB" data-reactid="12"><!-- react-text: 13 -->November 10th 2017<!-- /react-text --></div></header><article data-reactid="14"><p><img src="/blog/images/redux-saga.png" alt="redux-saga logo"></p>
<p>I think it’s pretty safe to say at this point that the vast majority of React code bases that need state management are using Redux. One of the things people like about Redux (yours truly included), is the testing story is great. Because reducers don’t allow mutating state, you’ll get the same result with the same input every time (yay functional paradigms!). But then there’s testing actions…</p>
<!--more-->
<h2>Action Testing With redux-thunk</h2>
<p>Why is action testing difficult? I have talked to people that said they don’t because it’s too hard or they don’t get enough value from it. My first follow-up question is what middleware they’re using to do asynchronous things in their actions and almost always the answer is <a href="https://github.com/gaearon/redux-thunk">redux-thunk</a>.</p>
<p>Don’t get me wrong, <code>redux-thunk</code> is great and I used it for quite a while. Pair <code>redux-thunk</code> up with <code>async</code>/<code>await</code> and you get some great looking code–until you try to test it. Let me illustrate.</p>
<p>Take <a href="https://github.com/bressain/ohai-redux-saga/blob/caefbc77e78d83e450aaf6ab92499d71e4d1197b/src/actions.js">this action</a> that makes a call to the <a href="https://swapi.co/">Star Wars API</a>. It’s simple enough: it creates a request to get information about a Star Wars film, awaits it, then dispatches a success event with the film data.</p>
<pre><code class="language-lang=js"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchFilm</span>(<span class="hljs-params">filmId</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (dispatch) =&gt; {
    dispatch(fetchFilmRequest(filmId))
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> api.fetchFilm.request(filmId)
    dispatch(fetchFilmSuccess(api.fetchFilm.deserializeSuccess(res)))
  }
}
</code></pre>
<p>Here’s the associated <a href="https://github.com/bressain/ohai-redux-saga/blob/caefbc77e78d83e450aaf6ab92499d71e4d1197b/src/__tests__/actions.spec.js">test</a>:</p>
<pre><code class="language-lang=js">describe('#fetchFilm', () =&gt; {
  let dispatch
  const res = { data: { title: 'wow', episode_id: <span class="hljs-number">3</span>, characters: [] } }
  const reqPromise = new Promise(<span class="hljs-name">resolve</span> =&gt; resolve(<span class="hljs-name">res</span>))

  beforeAll(<span class="hljs-name">async</span> () =&gt; {
    dispatch = jest.fn()
    api.fetchFilm.request = jest.fn(() =&gt; reqPromise)

    await actions.fetchFilm(<span class="hljs-number">3</span>)(<span class="hljs-name">dispatch</span>)
  })

  it('dispatches fetch request', () =&gt; {
    expect(<span class="hljs-name">dispatch</span>).toBeCalledWith({ type: TYPES.FETCH_FILM_REQUEST, filmId: <span class="hljs-number">3</span> })
  })

  it('calls api', () =&gt; {
    expect(<span class="hljs-name">api</span>.fetchFilm.request).toBeCalledWith(<span class="hljs-number">3</span>)
  })

  it('dispatches success event', async () =&gt; {
    const film = api.fetchFilm.deserializeSuccess(<span class="hljs-name">res</span>)
    await reqPromise
    expect(<span class="hljs-name">dispatch</span>).toBeCalledWith({ type: TYPES.FETCH_FILM_SUCCESS, film })
  })
})
</code></pre>
<p>Let’s be honest, <strong>the test isn’t terrible</strong>. There are a few mocks but it’s totally doable and it’s not unusual to for tests be larger than the code that they’re testing.</p>
<p>What happens when you need to do something like take the film result and <a href="https://github.com/bressain/ohai-redux-saga/blob/819c486af90f1381d8411553e87b8783fb110d01/src/actions.js">get all the people associated with that film</a>:</p>
<pre><code class="language-lang=js"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchFilm</span>(<span class="hljs-params">filmId</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (dispatch) =&gt; {
    dispatch(fetchFilmRequest(filmId))

    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> api.fetchFilm.request(filmId)
    <span class="hljs-keyword">const</span> film = api.fetchFilm.deserializeSuccess(res)
    dispatch(fetchFilmSuccess(film))

    <span class="hljs-keyword">await</span> <span class="hljs-built_in">Promise</span>.all(film.characters.map(<span class="hljs-function"><span class="hljs-params">personId</span> =&gt;</span> fetchPerson(personId)(dispatch)))
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetchPerson</span>(<span class="hljs-params">personId</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">async</span> (dispatch) =&gt; {
    dispatch(fetchPersonRequest(personId))
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> api.fetchPerson.request(personId)
    dispatch(fetchPersonSuccess(personId, api.fetchPerson.deserializeSuccess(res)))
  }
}
</code></pre>
<p>Good thing we went with <code>async</code>/<code>await</code>. It reads well and is (I hope) obvious what’s going on. Once we get the film, we spin through the characters, request their info, and then dispatch success to be picked up by the reducer. Let’s see how that affected the tests.</p>
<pre><code class="language-lang=js">describe('#fetchFilm', () =&gt; {
  let dispatch
  const characters = ['http<span class="hljs-symbol">://swapi</span>.co/api/people/1/', 'http<span class="hljs-symbol">://swapi</span>.co/api/people/2/']
  const characterIds = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]
  const res = { data: { title: 'wow', episode_id: <span class="hljs-number">3</span>, characters } }
  const reqPromise = new Promise(<span class="hljs-name">resolve</span> =&gt; resolve(<span class="hljs-name">res</span>))
  const personPromises = []
  const peopleRes = []

  beforeAll(<span class="hljs-name">async</span> () =&gt; {
    dispatch = jest.fn()
    api.fetchFilm.request = jest.fn(() =&gt; reqPromise)
    api.fetchPerson.request = jest.fn(() =&gt; {
      const pRes = { data: { name: 'Derp' } }
      const req = new Promise(<span class="hljs-name">resolve</span> =&gt; resolve(<span class="hljs-name">pRes</span>))
      personPromises.push(<span class="hljs-name">req</span>)
      peopleRes.push(<span class="hljs-name">pRes</span>)
      return req
    })

    await actions.fetchFilm(<span class="hljs-number">3</span>)(<span class="hljs-name">dispatch</span>)
  })

  it('dispatches fetch request', () =&gt; {
    expect(<span class="hljs-name">dispatch</span>).toBeCalledWith({ type: TYPES.FETCH_FILM_REQUEST, filmId: <span class="hljs-number">3</span> })
  })

  it('calls api', () =&gt; {
    expect(<span class="hljs-name">api</span>.fetchFilm.request).toBeCalledWith(<span class="hljs-number">3</span>)
  })

  it('calls api for characters', () =&gt; {
    expect(<span class="hljs-name">api</span>.fetchPerson.request).toBeCalledWith(<span class="hljs-number">1</span>)
    expect(<span class="hljs-name">api</span>.fetchPerson.request).toBeCalledWith(<span class="hljs-number">2</span>)
  })

  it('dispatches success event', async () =&gt; {
    const film = { ...api.fetchFilm.deserializeSuccess(<span class="hljs-name">res</span>), characters: characterIds }
    await reqPromise
    expect(<span class="hljs-name">dispatch</span>).toBeCalledWith({ type: TYPES.FETCH_FILM_SUCCESS, film })
  })

  it('dispatches person success events', async () =&gt; {
    const people = characterIds.map((<span class="hljs-name">id</span>, idx) =&gt; ({ ...api.fetchPerson.deserializeSuccess(<span class="hljs-name">peopleRes</span>[idx]), id }))
    await Promise.all(<span class="hljs-name">personPromises</span>)

    for (<span class="hljs-name">let</span> person of people) {
      expect(<span class="hljs-name">dispatch</span>).toBeCalledWith({ type: TYPES.FETCH_PERSON_SUCCESS, person })
    }
  })
})
</code></pre>
<p>Oh man, those two expressions sure did result in a lot of additional complexity in the tests. If we need to include more things to do within our action, the complexity is only going to be worse and the tests will be more brittle.</p>
<p>This is where people start throwing up their hands because they’re not getting as much value out of their tests. <strong>If the value of the tests aren’t outweighing the cost of maintaining them, good developers won’t test the code.</strong> So with that, we have a few options:</p>
<ol>
<li>Throw out our action tests and lean on reducer &amp; component testing only.</li>
<li>Find a library that abstracts this nastiness away.</li>
</ol>
<p>I chose #2 by moving to <a href="https://github.com/redux-saga/redux-saga">redux-saga</a>.</p>
<h2>Introducing redux-saga</h2>
<p><code>redux-saga</code> leans on using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Generator">generators</a> and the “effects as data” paradigm that <a href="https://guide.elm-lang.org/architecture/effects/">Elm</a> users are familiar with. <strong>Don’t worry about understanding those two things right now</strong>, only that <code>redux-saga</code> uses them and makes testing rad.</p>
<p>Let’s <a href="https://github.com/bressain/ohai-redux-saga/blob/master/src/actions.js">convert that action</a> to use <code>redux-saga</code>.</p>
<pre><code class="language-lang=js"><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">executeFetchFilm</span>(<span class="hljs-params">{ filmId }</span>) </span>{
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">yield</span> call(api.fetchFilm.request, filmId)
  <span class="hljs-keyword">const</span> film = api.fetchFilm.deserializeSuccess(res)
  <span class="hljs-keyword">yield</span> put(fetchFilmSuccess(film))

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> personId <span class="hljs-keyword">of</span> film.characters) {
    <span class="hljs-keyword">yield</span> put(fetchPerson(personId))
  }
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> fetchPerson = <span class="hljs-function"><span class="hljs-params">personId</span> =&gt;</span> ({
  <span class="hljs-attr">type</span>: TYPES.FETCH_PERSON_REQUEST,
  personId
})

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">executeFetchPerson</span>(<span class="hljs-params">{ personId }</span>) </span>{
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">yield</span> call(api.fetchPerson.request, personId)
  <span class="hljs-keyword">yield</span> put(fetchPersonSuccess(personId, api.fetchPerson.deserializeSuccess(res)))
}
</code></pre>
<p>You might be thinking, “This looks about the same size as the <code>redux-thunk</code> version, and perhaps a bit more complicated” and you’d be <strong>right</strong>, especially if you didn’t know what the <code>function*</code> thing is about. The asterisk indicates that this is a <strong>generator function</strong> and any time the <code>yield</code> keyword is used, execution effectively “pauses” until the statement completes (similar to <code>await</code>).</p>
<p><code>call</code> &amp; <code>put</code> are <code>redux-saga</code>-specific things that mean “call this method asynchronously” &amp; “dispatch an action” respectively. You’ll notice that we’re not dispatching request actions anymore at the beginning of the “execute” actions and there’s no clear connection between <code>fetchPerson</code> and <code>executeFetchPerson</code>. That magic happens <a href="https://github.com/bressain/ohai-redux-saga/blob/master/src/sagas.js">over here</a>:</p>
<pre><code class="language-lang=js"><span class="hljs-keyword">import</span> { takeEvery } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux-saga'</span>
<span class="hljs-keyword">import</span> { fork } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux-saga/effects'</span>

<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> actions <span class="hljs-keyword">from</span> <span class="hljs-string">'./actions'</span>
<span class="hljs-keyword">import</span> TYPES <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">watchEvery</span>(<span class="hljs-params">actionType, saga</span>) </span>{
  <span class="hljs-keyword">return</span> fork(<span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">yield</span>* takeEvery(actionType, saga)
  })
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">yield</span> [
    watchEvery(TYPES.FETCH_FILM_REQUEST, actions.executeFetchFilm),
    watchEvery(TYPES.FETCH_PERSON_REQUEST, actions.executeFetchPerson)
  ]
}
</code></pre>
<p>Because <code>redux-saga</code> is a redux middleware, it looks for those REQUEST actions and any time they see one, they call the respective generator function in the actions. There are fancier things that <code>redux-saga</code> can do but for now we’re just trying to do a straight cutover from <code>redux-thunk</code>.</p>
<h2>Testing With redux-saga</h2>
<p>Enough of that though, we’re not here to learn all the nooks and crannies of <code>redux-saga</code>, <strong>we’re here to improve our testing story!</strong> Let’s see how things changed:</p>
<pre><code class="language-lang=js">describe('#executeFetchFilm', () =&gt; {
  const characters = ['http<span class="hljs-symbol">://swapi</span>.co/api/people/1/', 'http<span class="hljs-symbol">://swapi</span>.co/api/people/2/']
  const characterIds = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]
  const res = { data: { title: 'wow', episode_id: <span class="hljs-number">3</span>, characters } }

  const iterator = actions.executeFetchFilm({ filmId: <span class="hljs-number">3</span> })

  it('calls api', () =&gt; {
    expect(<span class="hljs-name">iterator</span>.next().value).toEqual(<span class="hljs-name">call</span>(<span class="hljs-name">api</span>.fetchFilm.request, <span class="hljs-number">3</span>))
  })

  it('dispatches success event', () =&gt; {
    const film = { ...api.fetchFilm.deserializeSuccess(<span class="hljs-name">res</span>), characters: characterIds }
    expect(<span class="hljs-name">iterator</span>.next(<span class="hljs-name">res</span>).value).toEqual(<span class="hljs-name">put</span>({ type: TYPES.FETCH_FILM_SUCCESS, film }))
  })

  it('fetches characters', () =&gt; {
    expect(<span class="hljs-name">iterator</span>.next().value).toEqual(<span class="hljs-name">put</span>({ type: TYPES.FETCH_PERSON_REQUEST, personId: <span class="hljs-number">1</span> }))
    expect(<span class="hljs-name">iterator</span>.next().value).toEqual(<span class="hljs-name">put</span>({ type: TYPES.FETCH_PERSON_REQUEST, personId: <span class="hljs-number">2</span> }))
  })
})
</code></pre>
<p>Now <em>this</em> is something I can get on-board with. <strong>No mocking needed</strong> and nearly as clear as a reducer test. Once again, we’re using the <code>call</code> &amp; <code>put</code> constructs from <code>redux-saga</code> to help us but no APIs are getting called, and no redux actions are flying around.</p>
<p>How these tests work is each time <code>iterator.next()</code> is called, the next <code>yield</code> is called and the result is given in the <code>.value</code>. If something that a <code>yield</code>ed statement returned is needed for the next <code>yield</code> statement, just pass in something that would work into the next <code>iterator.next()</code> call, like we did with the API call result.</p>
<p>One caveat: this particular set of tests need to be run <em>in order</em> to run correctly. You could remedy this by creating the iterator in a <code>beforeEach</code> block and calling <code>iterator.next()</code> as many times as you needed in each <code>it</code> block to get to the specific thing you want to test.</p>
<h2>Make Action Testing Great Again</h2>
<p>I hope I’ve at least piqued your interest in testing your actions or giving you some tools to fix some brittle action tests. If you’re interested in seeing the whole code-base progression from <code>redux-thunk</code> to <code>redux-saga</code>, check out my repo at <a href="https://github.com/bressain/ohai-redux-saga">https://github.com/bressain/ohai-redux-saga</a> and view the commit diffs.</p>
<p>If you’ve found something even better, let me know in the comments!</p>
</article></section><nav class="_2cGs1ncVeWLYmD3Q1mIY2 _33G3p6bz1BpdLtEoXn5NMH _3TkJV_CnHmTFJnSPlpaVyl" data-reactid="15"><a class="_HJqmdx3qZVV_BpOPktPG" href="/blog/2017-05-21-more-adventures-in-losing-weight/" data-reactid="16">More Adventures In Losing Weight</a></nav><div class="_3vb6hOrOISn3hqR__wLJt4 _3TkJV_CnHmTFJnSPlpaVyl" data-reactid="17"><div data-reactid="18"><div id="disqus_thread" data-reactid="19"></div></div></div><footer class="_1yjGQbDuYsN6wsY_5bKZfL" data-reactid="20"><div class="EQiPokQQ5qUXDlsDCI8M2 _3TkJV_CnHmTFJnSPlpaVyl" data-reactid="21"><div class="_2tL3kkyqo20uOMENVoLDq-" data-reactid="22"><a href="/pages/about/" data-reactid="23"><img class="_1z3s2NjYfLLOlZUetX0rsg" src="https://www.gravatar.com/avatar/cd238df2a13bd0593a5be2ad19834c01?s=60" alt="about me" data-reactid="24"/></a><a href="https://twitter.com/bressain" data-reactid="25"><svg class="_3feOmGaJaw4_cyrDHPZqar" viewBox="0 0 800 800" data-reactid="26"><path d="M679 239s-21 34-55 57c7 156-107 329-314 329-103 0-169-50-169-50s81 17 163-45c-83-5-103-77-103-77s23 6 50-2c-93-23-89-110-89-110s23 14 50 14c-84-65-34-148-34-148s76 107 228 116c-22-121 117-177 188-101 37-6 71-27 71-27s-12 41-49 61c30-2 63-17 63-17z" data-reactid="27"></path></svg></a><a href="https://www.linkedin.com/in/bressaindinkelman/" data-reactid="28"><svg class="_3feOmGaJaw4_cyrDHPZqar" viewBox="0 0 800 800" data-reactid="29"><path d="M268 629h-97V319h97zm157 0h-97V319h93v42h1q31-50 93-50 114 0 114 133v185h-96V466q0-70-49-70-59 0-59 69z" data-reactid="30"></path><circle cx="219" cy="220" r="56" data-reactid="31"></circle></svg></a><a href="https://www.github.com/bressain/" data-reactid="32"><svg class="_3feOmGaJaw4_cyrDHPZqar" viewBox="0 0 800 800" data-reactid="33"><path d="M400 139c144 0 260 116 260 260 0 115-75 213-178 247-9 3-17-2-17-13v-71c0-35-18-48-18-48 57-6 119-28 119-128 0-44-27-70-27-70s14-29-2-69c0 0-22-7-72 27-42-12-88-12-130 0-50-34-72-27-72-27-16 40-2 69-2 69s-27 26-27 70c0 100 62 122 119 128 0 0-14 10-17 35-15 7-53 18-76-22 0 0-13-25-39-27 0 0-26 0-2 16 0 0 17 8 29 38 0 0 16 51 88 35v44c0 11-9 16-18 13-103-34-178-132-178-247 0-144 116-260 260-260z" data-reactid="34"></path></svg></a><a href="/atom.xml" data-reactid="35"><svg class="_3feOmGaJaw4_cyrDHPZqar" viewBox="0 0 800 800" data-reactid="36"><path d="M493 652H392c0-134-111-244-244-244V307c189 0 345 156 345 345zm71 0c0-228-188-416-416-416V132c285 0 520 235 520 520z" data-reactid="37"></path><circle cx="219" cy="581" r="71" data-reactid="38"></circle></svg></a></div><div class="_1bU9r8HJo0DQj5GQcGupks" data-reactid="39"><a class="_1leBCDTt2Qdk5Vslgg0fDV" rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" data-reactid="40"><img alt="Creative Commons License" style="border-width:0;" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" data-reactid="41"/></a><div class="tLPlNhsvgeiCDdhNn_Vci" data-reactid="42"><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" data-reactid="43">Articles licensed under CC BY-NC 4.0</a><br data-reactid="44"/><a rel="license" href="https://opensource.org/licenses/MIT" data-reactid="45">Code licensed under MIT</a></div></div></div></footer></div></div></div></div><script src="/bundle.js?t=1510330433870"></script></body></html>